#!/bin/bash

# One-liner installer for mdtasks
# Usage: curl -sSL https://raw.githubusercontent.com/crooy/mdtasks/main/install | bash

set -e

echo "üöÄ Installing mdtasks..."

# Check if git is available
if ! command -v git &> /dev/null; then
    echo "‚ùå Git is required but not installed. Please install git first."
    exit 1
fi

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "‚ùå Cargo is required but not installed. Please install Rust first:"
    echo "   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
    exit 1
fi

# Create temporary directory
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# Get the latest release
echo "üì• Getting latest mdtasks release..."
LATEST_RELEASE=$(curl -s https://api.github.com/repos/crooy/mdtasks/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

if [ -z "$LATEST_RELEASE" ]; then
    echo "‚ùå Could not determine latest release. Falling back to source installation..."
    # Fallback to source installation
    git clone https://github.com/crooy/mdtasks.git
    cd mdtasks
    chmod +x scripts/install.sh
    ./scripts/install.sh
else
    echo "üì¶ Installing mdtasks $LATEST_RELEASE..."

    # Detect OS and architecture
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)

    case $OS in
        linux)
            case $ARCH in
                x86_64) ARCH="x86_64" ;;
                aarch64) ARCH="aarch64" ;;
                *) echo "‚ùå Unsupported Linux architecture: $ARCH"; exit 1 ;;
            esac
            ;;
        darwin)
            case $ARCH in
                x86_64) ARCH="x86_64" ;;
                arm64) ARCH="aarch64" ;;
                *) echo "‚ùå Unsupported macOS architecture: $ARCH"; exit 1 ;;
            esac
            ;;
        *)
            echo "‚ùå Unsupported operating system: $OS"
            echo "Please install manually from: https://github.com/crooy/mdtasks/releases"
            exit 1
            ;;
    esac

    # Download and install
    DOWNLOAD_URL="https://github.com/crooy/mdtasks/releases/download/$LATEST_RELEASE/mdtasks-${OS}-${ARCH}.tar.gz"
    echo "üì• Downloading from: $DOWNLOAD_URL"

    curl -L -o mdtasks.tar.gz "$DOWNLOAD_URL"
    tar -xzf mdtasks.tar.gz

    # Install
    echo "üîß Installing mdtasks..."
    mkdir -p ~/.local/bin
    mv mdtasks ~/.local/bin/
    echo "‚úÖ Installed to ~/.local/bin/mdtasks"
    echo "Add ~/.local/bin to your PATH if it's not already there"

    chmod +x ~/.local/bin/mdtasks
fi

# Cleanup
cd /
rm -rf "$TEMP_DIR"

echo "‚úÖ mdtasks installed successfully!"
echo "Run 'mdtasks --help' to get started."
